import _objectWithoutPropertiesLoose from "@babel/runtime/helpers/esm/objectWithoutPropertiesLoose";
const _excluded = ["callback"],
  _excluded2 = ["callback"],
  _excluded3 = ["callback"],
  _excluded4 = ["callback"];
import { all, call, put, takeEvery, takeLeading, select } from 'redux-saga/effects';
import { api } from '@frontegg/rest-api';
import { actions } from '../reducer';
import { rolesAdminViewerDemo } from '../dummy';
import { errorHandler } from '../../utils';
import { RolesStateKeys } from './types';
function* loadRolesAndPermissions({
  payload
}) {
  var _payload$silentLoadin;
  const key = RolesStateKeys.LOAD_ROLES;
  yield put(actions.setRolesStateLoader({
    key,
    value: !((_payload$silentLoadin = payload == null ? void 0 : payload.silentLoading) != null ? _payload$silentLoadin : false)
  }));
  try {
    const result = yield all([call(api.roles.getRoles), call(api.roles.getPermissions), call(api.roles.getPermissionCategories)]);
    const [roles, permissions, permissionCategories] = result;
    const {
      selectedRole
    } = yield select(state => state.auth.rolesState);
    const updatedSelectedRole = roles == null ? void 0 : roles.find(({
      id: roleId
    }) => (selectedRole == null ? void 0 : selectedRole.id) === roleId);
    yield put(actions.setRolesState({
      roles,
      permissions,
      permissionCategories,
      selectedRole: updatedSelectedRole
    }));
  } catch (e) {
    yield put(actions.setRolesStateError({
      key,
      value: errorHandler(e)
    }));
  } finally {
    yield put(actions.setRolesStateLoader({
      key,
      value: false
    }));
  }
}
function* addRole(_ref) {
  let {
      payload: {
        callback
      }
    } = _ref,
    body = _objectWithoutPropertiesLoose(_ref.payload, _excluded);
  const key = RolesStateKeys.ADD_ROLE;
  yield put(actions.setRolesStateLoader({
    key,
    value: true
  }));
  try {
    const role = yield call(api.roles.addRole, body);
    const roles = yield call(api.roles.getRoles);
    yield put(actions.loadRolesAndPermissions({
      silentLoading: true
    }));
    yield put(actions.setRolesState({
      roles
    }));
    callback == null ? void 0 : callback(role);
  } catch (e) {
    yield put(actions.setRolesStateError({
      key,
      value: errorHandler(e)
    }));
    callback == null ? void 0 : callback(null, e);
  } finally {
    yield put(actions.setRolesStateLoader({
      key,
      value: false
    }));
  }
}
function* deleteRole(_ref2) {
  let {
      payload: {
        callback
      }
    } = _ref2,
    body = _objectWithoutPropertiesLoose(_ref2.payload, _excluded2);
  const key = RolesStateKeys.DELETE_ROLE_DIALOG;
  yield put(actions.setRolesStateLoader({
    key,
    value: true
  }));
  try {
    yield call(api.roles.deleteRole, body);
    yield put(actions.loadRolesAndPermissions({
      silentLoading: true
    }));
    callback == null ? void 0 : callback(true);
  } catch (e) {
    yield put(actions.setRolesStateError({
      key,
      value: errorHandler(e)
    }));
    callback == null ? void 0 : callback(false, e);
  } finally {
    yield put(actions.setRolesStateLoader({
      key,
      value: false
    }));
  }
}
function* updateRole(_ref3) {
  let {
      payload: {
        callback
      }
    } = _ref3,
    body = _objectWithoutPropertiesLoose(_ref3.payload, _excluded3);
  const key = RolesStateKeys.EDIT_ROLE_DIALOG;
  yield put(actions.setRolesStateLoader({
    key,
    value: true
  }));
  try {
    const role = yield call(api.roles.updateRole, body);
    yield put(actions.loadRolesAndPermissions({
      silentLoading: true
    }));
    callback == null ? void 0 : callback(role);
  } catch (e) {
    yield put(actions.setRolesStateError({
      key,
      value: errorHandler(e)
    }));
    callback == null ? void 0 : callback(null, e);
  } finally {
    yield put(actions.setRolesStateLoader({
      key,
      value: false
    }));
  }
}
function* attachPermissionsToRole(_ref4) {
  let {
      payload: {
        callback
      }
    } = _ref4,
    body = _objectWithoutPropertiesLoose(_ref4.payload, _excluded4);
  const key = RolesStateKeys.MANAGE_PERMISSIONS;
  yield put(actions.setRolesStateLoader({
    key,
    value: true
  }));
  try {
    const role = yield call(api.roles.attachPermissionsToRole, body);
    yield put(actions.loadRolesAndPermissions({
      silentLoading: true
    }));
    callback == null ? void 0 : callback(role);
  } catch (e) {
    yield put(actions.setRolesStateError({
      key,
      value: errorHandler(e)
    }));
    callback == null ? void 0 : callback(null, e);
  } finally {
    yield put(actions.setRolesStateLoader({
      key,
      value: false
    }));
  }
}
export function* rolesSagas() {
  yield takeLeading(actions.loadRolesAndPermissions, loadRolesAndPermissions);
  yield takeEvery(actions.addRole, addRole);
  yield takeEvery(actions.deleteRole, deleteRole);
  yield takeEvery(actions.updateRole, updateRole);
  yield takeEvery(actions.attachPermissionsToRole, attachPermissionsToRole);
}

/*********************************
 *  Preview Sagas
 *********************************/

function* loadRolesAndPermissionsMock({
  payload
}) {
  var _payload$silentLoadin2;
  const key = RolesStateKeys.LOAD_ROLES;
  yield put(actions.setRolesStateLoader({
    key,
    value: !((_payload$silentLoadin2 = payload == null ? void 0 : payload.silentLoading) != null ? _payload$silentLoadin2 : false)
  }));
  try {
    yield put(actions.setRolesState({
      roles: rolesAdminViewerDemo
    }));
  } catch (e) {
    yield put(actions.setRolesStateError({
      key,
      value: errorHandler(e)
    }));
  } finally {
    yield put(actions.setRolesStateLoader({
      key,
      value: false
    }));
  }
}
export function* rolesSagasMock() {
  yield takeLeading(actions.loadRolesAndPermissions, loadRolesAndPermissionsMock);
}