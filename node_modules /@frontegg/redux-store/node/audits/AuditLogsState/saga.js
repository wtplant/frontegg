"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.auditLogsSagas = auditLogsSagas;
exports.auditLogsSagasMock = auditLogsSagasMock;
var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));
var _effects = require("redux-saga/effects");
var _restApi = require("@frontegg/rest-api");
var _reducer = require("../reducer");
var _constants = require("../../constants");
var _dummy = require("../dummy");
var _utils = require("../../utils");
const select = () => (0, _effects.select)(_ => _[_constants.auditsStoreName].auditLogsState);
const selectMetadata = () => (0, _effects.select)(_ => _[_constants.auditsStoreName].auditsMetadataState);
function* exportAuditsCsv() {
  const state = yield select();
  const {
    columns
  } = yield selectMetadata();
  try {
    const filter = state.filter;
    const sort = state.sort;
    const sortParams = sort.reduce((p, n) => (0, _extends2.default)({}, p, {
      sortBy: n.id,
      sortDirection: n.desc ? 'desc' : 'asc'
    }), {});
    const filterParams = filter.reduce((p, n) => (0, _extends2.default)({}, p, {
      [n.id]: n.value
    }), {});
    yield (0, _effects.put)(_reducer.actions.setAuditLogsState({
      isDownloadingCsv: true
    }));
    const outputFileName = `audits.csv`;
    yield _restApi.api.audits.exportAudits((0, _extends2.default)({
      endpoint: 'csv/v2',
      headerProps: columns,
      offset: 0,
      outputFileName
    }, sortParams, filterParams));
  } catch (e) {
    console.error('failed to export audits - ', e);
  }
  yield (0, _effects.put)(_reducer.actions.setAuditLogsState({
    isDownloadingCsv: false
  }));
}
function* loadAuditLogs({
  payload
}) {
  yield (0, _effects.put)(_reducer.actions.setAuditLogsState({
    loading: !(payload != null && payload.silentLoading),
    error: null
  }));
  const state = yield select();
  const {
    columns
  } = yield selectMetadata();
  try {
    var _payload$pageSize, _payload$pageOffset, _payload$filter, _payload$sort, _payload$callback;
    const pageSize = (_payload$pageSize = payload.pageSize) != null ? _payload$pageSize : state.pageSize;
    const pageOffset = (_payload$pageOffset = payload.pageOffset) != null ? _payload$pageOffset : state.pageOffset;
    const filter = (_payload$filter = payload.filter) != null ? _payload$filter : state.filter;
    const sort = (_payload$sort = payload.sort) != null ? _payload$sort : state.sort;
    yield (0, _effects.put)(_reducer.actions.setAuditLogsState({
      pageSize,
      pageOffset,
      filter,
      sort
    }));
    const sortParams = sort.reduce((p, n) => (0, _extends2.default)({}, p, {
      sortBy: n.id,
      sortDirection: n.desc ? 'desc' : 'asc'
    }), {});
    const filterParams = filter.reduce((p, n) => (0, _extends2.default)({}, p, {
      [n.id]: n.value
    }), {});
    if (!columns) {
      yield (0, _effects.put)(_reducer.actions.loadAuditsMetadata());
    }
    const {
      data,
      total
    } = yield (0, _effects.call)(_restApi.api.audits.getAudits, (0, _extends2.default)({
      offset: pageOffset,
      count: pageSize
    }, sortParams, filterParams));
    yield (0, _effects.put)(_reducer.actions.setAuditLogsState({
      loading: false,
      logs: data != null ? data : [],
      totalPages: +Math.ceil(total / pageSize)
    }));
    payload == null ? void 0 : (_payload$callback = payload.callback) == null ? void 0 : _payload$callback.call(payload, true);
  } catch (e) {
    var _payload$callback2;
    yield (0, _effects.put)(_reducer.actions.setAuditLogsState({
      loading: false,
      error: (0, _utils.errorHandler)(e)
    }));
    payload == null ? void 0 : (_payload$callback2 = payload.callback) == null ? void 0 : _payload$callback2.call(payload, null, e);
  }
}
function* auditLogsSagas() {
  yield (0, _effects.takeEvery)(_reducer.actions.exportAuditsCsv, exportAuditsCsv);
  yield (0, _effects.takeEvery)(_reducer.actions.loadAuditLogs, loadAuditLogs);
}

/*********************************
 *  Preview Sagas
 *********************************/

function* loadAuditLogsMock({
  payload
}) {
  yield (0, _effects.put)(_reducer.actions.setAuditLogsState({
    loading: !(payload != null && payload.silentLoading),
    error: null
  }));
  const state = yield select();
  const {
    columns
  } = yield selectMetadata();
  try {
    var _payload$pageSize2, _payload$pageOffset2, _payload$filter2, _payload$sort2, _payload$callback3;
    const pageSize = (_payload$pageSize2 = payload.pageSize) != null ? _payload$pageSize2 : state.pageSize;
    const pageOffset = (_payload$pageOffset2 = payload.pageOffset) != null ? _payload$pageOffset2 : state.pageOffset;
    const filter = (_payload$filter2 = payload.filter) != null ? _payload$filter2 : state.filter;
    const sort = (_payload$sort2 = payload.sort) != null ? _payload$sort2 : state.sort;
    yield (0, _effects.put)(_reducer.actions.setAuditLogsState({
      pageSize,
      pageOffset,
      filter,
      sort
    }));
    if (!columns) {
      yield (0, _effects.put)(_reducer.actions.loadAuditsMetadata());
    }
    const {
      data,
      total
    } = (0, _dummy.auditsLogsFilterAndSort)(filter, sort);
    yield (0, _effects.put)(_reducer.actions.setAuditLogsState({
      loading: false,
      logs: data != null ? data : [],
      totalPages: +Math.ceil(total / pageSize)
    }));
    payload == null ? void 0 : (_payload$callback3 = payload.callback) == null ? void 0 : _payload$callback3.call(payload, true);
  } catch (e) {
    var _payload$callback4;
    yield (0, _effects.put)(_reducer.actions.setAuditLogsState({
      loading: false,
      error: (0, _utils.errorHandler)(e)
    }));
    payload == null ? void 0 : (_payload$callback4 = payload.callback) == null ? void 0 : _payload$callback4.call(payload, null, e);
  }
}
function* auditLogsSagasMock() {
  yield (0, _effects.takeEvery)(_reducer.actions.loadAuditLogs, loadAuditLogsMock);
}