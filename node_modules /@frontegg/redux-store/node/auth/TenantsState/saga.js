"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.tenantsSagas = tenantsSagas;
exports.tenantsSagasMock = tenantsSagasMock;
var _effects = require("redux-saga/effects");
var _restApi = require("@frontegg/rest-api");
var _reducer = require("../reducer");
var _utils = require("../utils");
var _dummy = require("../dummy");
var _saga = require("../LoginState/saga");
function* switchTenant({
  payload: {
    tenantId,
    callback
  }
}) {
  yield (0, _effects.put)(_reducer.actions.setState({
    isLoading: true
  }));
  try {
    yield (0, _effects.call)(_restApi.api.tenants.switchTenant, {
      tenantId
    });
    yield (0, _effects.call)(_saga.refreshToken);
    const callbackConsumed = callback == null ? void 0 : callback(true);
    if (!callbackConsumed) {
      yield (0, _effects.put)(_reducer.actions.setState({
        isLoading: false
      }));
    }
  } catch (e) {
    yield (0, _effects.put)(_reducer.actions.setState({
      isLoading: false
    }));
    callback == null ? void 0 : callback(false, e);
  }
}
function* loadTenants({
  payload
}) {
  yield (0, _effects.put)(_reducer.actions.setTenantsState({
    loading: true
  }));
  try {
    var _payload$callback;
    const userTenantsResponse = yield (0, _effects.call)((0, _restApi.getCurrentUserTenantsFunction)());
    yield (0, _effects.put)(_reducer.actions.setTenantsState({
      tenants: userTenantsResponse.tenants,
      activeTenant: userTenantsResponse.activeTenant,
      loading: false
    }));
    payload == null ? void 0 : (_payload$callback = payload.callback) == null ? void 0 : _payload$callback.call(payload, []);
  } catch (e) {
    var _payload$callback2;
    payload == null ? void 0 : (_payload$callback2 = payload.callback) == null ? void 0 : _payload$callback2.call(payload, [], e);
    yield (0, _effects.put)(_reducer.actions.setTenantsState({
      loading: false
    }));
  }
}
function* loadSubTenants({
  payload
}) {
  yield (0, _effects.put)(_reducer.actions.setTenantsState({
    loading: true
  }));
  try {
    var _payload$callback3;
    const subTenants = yield (0, _effects.call)(_restApi.api.tenants.getSubTenants);
    yield (0, _effects.put)(_reducer.actions.setTenantsState({
      subTenants,
      loading: false
    }));
    payload == null ? void 0 : (_payload$callback3 = payload.callback) == null ? void 0 : _payload$callback3.call(payload, true);
  } catch (e) {
    var _payload$callback4;
    yield (0, _effects.put)(_reducer.actions.setTenantsState({
      loading: false
    }));
    payload == null ? void 0 : (_payload$callback4 = payload.callback) == null ? void 0 : _payload$callback4.call(payload, null, e);
  }
}
function* loadSubTenantsTree({
  payload
}) {
  yield (0, _effects.put)(_reducer.actions.setTenantsState({
    loading: true
  }));
  try {
    var _payload$callback5;
    const tenantTree = yield (0, _effects.call)(_restApi.api.tenants.getSubTenantsAsTree);
    yield (0, _effects.put)(_reducer.actions.setTenantsState({
      tenantTree,
      loading: false
    }));
    payload == null ? void 0 : (_payload$callback5 = payload.callback) == null ? void 0 : _payload$callback5.call(payload, true);
  } catch (e) {
    var _payload$callback6;
    yield (0, _effects.put)(_reducer.actions.setTenantsState({
      loading: false
    }));
    payload == null ? void 0 : (_payload$callback6 = payload.callback) == null ? void 0 : _payload$callback6.call(payload, null, e);
  }
}
function* tenantsSagas() {
  yield (0, _effects.takeEvery)(_reducer.actions.loadTenants, loadTenants);
  yield (0, _effects.takeEvery)(_reducer.actions.loadSubTenants, loadSubTenants);
  yield (0, _effects.takeEvery)(_reducer.actions.switchTenant, switchTenant);
  yield (0, _effects.takeEvery)(_reducer.actions.loadSubTenantsTree, loadSubTenantsTree);
}

/*********************************
 *  Preview Sagas
 *********************************/

function* loadTenantsMock() {
  yield (0, _effects.put)(_reducer.actions.setTenantsState({
    loading: true
  }));
  yield (0, _utils.delay)();
  yield (0, _effects.put)(_reducer.actions.setTenantsState({
    tenants: _dummy.tenantsDemo,
    activeTenant: _dummy.tenantsDemo[0],
    loading: false
  }));
}
function* tenantsSagasMock() {
  yield (0, _effects.takeEvery)(_reducer.actions.loadTenants, loadTenantsMock);
}