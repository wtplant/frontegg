"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.customLoginEnabled = customLoginEnabled;
exports.customLoginSagas = customLoginSagas;
exports.customLoginSagasMock = customLoginSagasMock;
exports.getCustomLoginAlias = getCustomLoginAlias;
exports.loadCustomLoginRoutes = loadCustomLoginRoutes;
exports.loadTenantMetadata = loadTenantMetadata;
var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));
var _objectWithoutPropertiesLoose2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutPropertiesLoose"));
var _restApi = require("@frontegg/rest-api");
var _effects = require("redux-saga/effects");
var _reducer = require("../reducer");
var _utils = require("../utils");
var _utils2 = require("./utils");
var _utils3 = require("../../utils");
var _utils4 = require("../LoginState/utils");
const _excluded = ["callback"],
  _excluded2 = ["callback"];
function* loadTenantMetadata() {
  yield (0, _effects.put)(_reducer.actions.setCustomLoginState({
    loading: true
  }));
  try {
    const tenantMetadata = yield (0, _effects.call)(_restApi.api.metadata.getAdminBoxMetadata);
    yield (0, _effects.put)(_reducer.actions.setCustomLoginState({
      tenantMetadata,
      loading: false
    }));
  } catch (e) {
    yield (0, _effects.put)(_reducer.actions.setCustomLoginState({
      loading: false,
      error: (0, _utils3.errorHandler)(e)
    }));
  }
}
function* updateTenantMetadata(_ref) {
  let {
      payload: {
        callback
      }
    } = _ref,
    state = (0, _objectWithoutPropertiesLoose2.default)(_ref.payload, _excluded);
  try {
    yield (0, _effects.put)(_reducer.actions.setCustomLoginState({
      error: null,
      saving: true
    }));
    const requestActions = (0, _utils2.mapMetaDataObjectToActions)(state);
    if (requestActions.length === 0) {
      throw new Error('No changes to update');
    }
    yield (0, _effects.call)(_restApi.api.metadata.updateAdminBoxMetadata, {
      actions: requestActions
    });
    const tenantMetadata = yield (0, _effects.call)(_restApi.api.metadata.getAdminBoxMetadata);
    yield (0, _effects.put)(_reducer.actions.setCustomLoginState({
      tenantMetadata,
      saving: false
    }));
    callback == null ? void 0 : callback(true);
  } catch (e) {
    yield (0, _effects.put)(_reducer.actions.setCustomLoginState({
      error: (0, _utils3.errorHandler)(e, 'No changes to update'),
      saving: false
    }));
    callback == null ? void 0 : callback(null, e);
  }
}
function* customLoginEnabled() {
  const customLoginAlias = yield (0, _effects.call)(getCustomLoginAlias);
  return !!customLoginAlias;
}
function* getCustomLoginAlias() {
  const context = _restApi.ContextHolder.getContext();
  if (!(context != null && context.tenantResolver)) {
    return;
  }
  const resolvedTenantResult = yield context.tenantResolver();
  if (resolvedTenantResult != null && resolvedTenantResult.tenant) {
    return resolvedTenantResult.tenant;
  }
  const {
    customLoginAlias,
    hasCustomLogin
  } = yield (0, _effects.select)(state => {
    var _state$auth, _state$auth$tenantsSt;
    const activeTenant = (_state$auth = state.auth) == null ? void 0 : (_state$auth$tenantsSt = _state$auth.tenantsState) == null ? void 0 : _state$auth$tenantsSt.activeTenant;
    return {
      customLoginAlias: activeTenant == null ? void 0 : activeTenant.alias,
      hasCustomLogin: activeTenant == null ? void 0 : activeTenant.hasCustomLogin
    };
  });
  if (hasCustomLogin) {
    return customLoginAlias;
  }
}
function* loadCustomLoginRoutes() {
  try {
    var _getSearchParamsFromU;
    const isCustomLoginEnabled = yield (0, _effects.call)(customLoginEnabled);
    if (!isCustomLoginEnabled) {
      return;
    }
    const isAuthenticated = yield (0, _effects.select)(state => state.auth.isAuthenticated);
    const {
      getSettings,
      getPublicSettings
    } = _restApi.api.accountSettings;
    const {
      applicationUrl
    } = yield (0, _effects.call)(isAuthenticated ? getSettings : getPublicSettings);
    if (!applicationUrl) {
      return;
    }
    const {
      routes
    } = yield (0, _effects.select)(state => state.auth);
    const searchParams = (_getSearchParamsFromU = (0, _utils4.getSearchParamsFromUrl)(applicationUrl)) != null ? _getSearchParamsFromU : '';
    yield (0, _effects.put)(_reducer.actions.setState({
      routes: (0, _extends2.default)({}, routes, {
        customLoginAuthenticatedUrl: applicationUrl,
        customLoginUrl: routes.loginUrl + searchParams
      })
    }));
    yield (0, _effects.put)(_reducer.actions.setCustomLoginState({
      customLoginSearchParams: searchParams != null ? searchParams : undefined
    }));
  } catch {}
}
function* customLoginSagas() {
  yield (0, _effects.takeLeading)(_reducer.actions.loadTenantMetadata, loadTenantMetadata);
  yield (0, _effects.takeLeading)(_reducer.actions.updateTenantMetadata, updateTenantMetadata);
}

// /*********************************
//  *  Preview Sagas
//  *********************************/

function* loadCustomLoginStateMock() {
  yield (0, _effects.put)(_reducer.actions.setCustomLoginState({
    loading: true
  }));
  yield (0, _utils.delay)();
  yield (0, _effects.put)(_reducer.actions.setCustomLoginState({
    loading: false
  }));
}
function* updateCustomLoginMetadataMock(_ref2) {
  let {
      payload: {
        callback
      }
    } = _ref2,
    payload = (0, _objectWithoutPropertiesLoose2.default)(_ref2.payload, _excluded2);
  yield (0, _effects.put)(_reducer.actions.setCustomLoginState({
    loading: true,
    error: null
  }));
  yield (0, _utils.delay)();
  yield (0, _effects.put)(_reducer.actions.setCustomLoginState({
    loading: false,
    error: null
  }));
  callback == null ? void 0 : callback(true);
}
function* customLoginSagasMock() {
  yield (0, _effects.takeLeading)(_reducer.actions.loadTenantMetadata, loadCustomLoginStateMock);
  yield (0, _effects.takeLeading)(_reducer.actions.updateTenantMetadata, updateCustomLoginMetadataMock);
}