"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.generateStepUpSession = generateStepUpSession;
var _effects = require("redux-saga/effects");
var _restApi = require("@frontegg/rest-api");
var _reducer = require("../reducer");
var _utils = require("../LoginState/utils");
var _interfaces = require("../MfaState/interfaces");
var _sagas = require("../LoginState/sagas");
var _saga = require("../LoginState/saga.utils");
var _consts = require("./consts");
/**
 * Error returned from the BE when the user is not enrolled to MFA and logged in with email magic code/link
 */
const MFA_IS_NOT_ENROLLED_ERROR = 'MFA is not enrolled';

/**
 * @param error API error
 * @returns true when the error is MFA is not enrolled error
 */
const isMfaIsNotEnrolledError = error => (error == null ? void 0 : error['message']) === MFA_IS_NOT_ENROLLED_ERROR;

/**
 * Handle an edge case when the user should NOT step up, so the response including the generated stepped-up jwt
 * Relevant for scenarios like login with magic code, no other mfa enrolled, allowed to skip mfa and max age is valid
 * @param generateResponse
 */
function* handleNoNeedToStepUpFlow(generateResponse) {
  yield (0, _effects.call)(_saga.afterAuthenticationStateUpdate, generateResponse);
  yield (0, _effects.call)(_sagas.afterStepUpAuthNavigation);
}

/**
 * Handle the common scenario when the user should step up by the mfa token and devices returned from the generate req
 * @param generateStepUpSessionResponse
 */
function* handleNeedToStepUpFlow({
  mfaToken,
  mfaDevices
}) {
  yield (0, _effects.put)(_reducer.actions.setStepUpState({
    mfaDevices,
    mfaToken
  }));

  // to handle scenarios when sms, email or authenticator are the only options - show immediately the enrolled one
  const step = yield (0, _effects.call)(_utils.getMfaStepForEnrolledUsers, mfaDevices);
  yield (0, _effects.put)(_reducer.actions.setMfaState({
    step
  }));
}

/**
 * Handle step up generation request error
 * @param error
 */
function* handleError(error) {
  if (isMfaIsNotEnrolledError(error)) {
    yield (0, _effects.put)(_reducer.actions.setMfaState({
      step: _interfaces.MFAStep.noMFAEnrolledStepUp
    }));
    return;
  }
  window.localStorage.setItem(_consts.SHOULD_STEP_UP_KEY, 'true');
  const {
    routes
  } = yield (0, _effects.select)(state => state.auth);
  _restApi.ContextHolder.onRedirectTo(routes.logoutUrl, {
    preserveQueryParams: true
  });
}

/**
 * Generate step up session
 * Logout on error and redirecting to the login page
 * @param payload.maxAge - The max age of the session in seconds
 * @param payload.callback - The callback function to be called after the request is done
 */
function* generateStepUpSession({
  payload: {
    maxAge,
    callback
  }
}) {
  yield (0, _effects.put)(_reducer.actions.setStepUpState({
    mfaDevices: undefined,
    mfaToken: ''
  }));
  try {
    const response = yield (0, _effects.call)(_restApi.api.auth.generateStepupSession, {
      maxAge
    });
    if (response['user']) {
      // got stepped up jwt, no need to continue step up by a second factor
      yield (0, _effects.call)(handleNoNeedToStepUpFlow, response);
    } else {
      // regular step up flow
      yield (0, _effects.call)(handleNeedToStepUpFlow, response);
    }
    callback == null ? void 0 : callback(true);
  } catch (e) {
    callback == null ? void 0 : callback(false);
    yield (0, _effects.call)(handleError, e);
  }
}