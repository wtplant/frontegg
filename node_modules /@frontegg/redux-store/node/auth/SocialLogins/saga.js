"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getSocialLoginsConfigurationsV2 = getSocialLoginsConfigurationsV2;
exports.loadSocialLoginsConfigurations = loadSocialLoginsConfigurations;
exports.loadSocialLoginsConfigurationsV2 = loadSocialLoginsConfigurationsV2;
exports.socialLoginsSaga = socialLoginsSaga;
var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));
var _objectWithoutPropertiesLoose2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutPropertiesLoose"));
var _restApi = require("@frontegg/rest-api");
var _effects = require("redux-saga/effects");
var _saga = require("../LoginState/saga");
var _reducer = require("../reducer");
var _interfaces = require("../interfaces");
var _utils = require("../../utils");
const _excluded = ["authorizationUrl"],
  _excluded2 = ["events", "url"];
function* loadSocialLoginsConfigurations() {
  try {
    yield (0, _effects.put)(_reducer.actions.setSocialLoginsState({
      loading: true
    }));
    const socialLoginsConfig = yield (0, _effects.call)(_restApi.api.auth.getSocialLoginProviders);
    yield (0, _effects.put)(_reducer.actions.setSocialLoginsState({
      socialLoginsConfig,
      loading: false,
      firstLoad: false
    }));
  } catch (e) {
    yield (0, _effects.put)(_reducer.actions.setSocialLoginsState({
      error: (0, _utils.errorHandler)(e),
      loading: false,
      firstLoad: false
    }));
  }
}
function* getSocialLoginsConfigurationsV2() {
  const isAuthenticated = yield (0, _effects.select)(({
    auth
  }) => auth.isAuthenticated);
  let socialLoginsConfigV2;
  if (isAuthenticated) {
    socialLoginsConfigV2 = yield (0, _effects.call)(_restApi.api.auth.getSocialLoginProvidersV2ForAuthenticatedUser);
  } else {
    socialLoginsConfigV2 = yield (0, _effects.call)(_restApi.api.auth.getSocialLoginProvidersV2);
  }
  return socialLoginsConfigV2;
}
function* loadSocialLoginsConfigurationsV2(action) {
  try {
    var _action$payload, _action$payload$callb;
    const context = yield (0, _effects.select)(state => state.root.context);
    yield (0, _effects.put)(_reducer.actions.setSocialLoginsState({
      loading: true
    }));
    const socialLoginsConfigV2 = yield (0, _effects.call)(getSocialLoginsConfigurationsV2);
    const {
      providers: customSocialLoginsConfig
    } = yield (0, _effects.call)(_restApi.api.auth.getCustomSocialLoginProvidersV1);
    const socialLoginsConfigWithFullUrl = socialLoginsConfigV2.map(_ref => {
      let {
          authorizationUrl
        } = _ref,
        config = (0, _objectWithoutPropertiesLoose2.default)(_ref, _excluded);
      const baseUrl = _restApi.fetch.getBaseUrl(context, authorizationUrl != null ? authorizationUrl : '');
      return (0, _extends2.default)({}, config, {
        authorizationUrl: authorizationUrl ? `${baseUrl}${authorizationUrl}` : null
      });
    });
    const newState = {
      socialLoginsConfigV2: socialLoginsConfigWithFullUrl,
      customSocialLoginsConfig,
      loading: false,
      firstLoad: false
    };
    yield (0, _effects.put)(_reducer.actions.setSocialLoginsState(newState));
    action == null ? void 0 : (_action$payload = action.payload) == null ? void 0 : (_action$payload$callb = _action$payload.callback) == null ? void 0 : _action$payload$callb.call(_action$payload, newState);
  } catch (e) {
    var _action$payload2, _action$payload2$call;
    action == null ? void 0 : (_action$payload2 = action.payload) == null ? void 0 : (_action$payload2$call = _action$payload2.callback) == null ? void 0 : _action$payload2$call.call(_action$payload2, null, e);
    yield (0, _effects.put)(_reducer.actions.setSocialLoginsState({
      error: (0, _utils.errorHandler)(e),
      loading: false,
      firstLoad: false
    }));
  }
}
function* loginViaSocialLogin(_ref2) {
  let {
      payload: {
        events,
        url
      }
    } = _ref2,
    payload = (0, _objectWithoutPropertiesLoose2.default)(_ref2.payload, _excluded2);
  try {
    yield (0, _effects.put)(_reducer.actions.setSocialLoginsState({
      loading: true
    }));
    const {
      email,
      isNewUser,
      userId,
      tenantId,
      name
    } = yield (0, _effects.call)(_restApi.api.auth.loginViaSocialLogin, payload);
    if (isNewUser) {
      var _events$signUpComplet, _events$userVerified;
      const basePayload = {
        email,
        url,
        createdAt: new Date(),
        id: userId,
        tenantId
      };
      const signUpCompletePayload = (0, _extends2.default)({}, basePayload, {
        socialProvider: payload.provider,
        authenticationType: _interfaces.AuthenticationTypes.SOCIAL_LOGIN
      });
      events == null ? void 0 : (_events$signUpComplet = events.signUpComplete) == null ? void 0 : _events$signUpComplet.call(events, signUpCompletePayload);
      (0, _utils.reportGTMEvent)(_utils.GTMEventAction.SIGNUP_COMPLETED, signUpCompletePayload);
      const userVerifiedPayload = (0, _extends2.default)({}, basePayload, {
        origin: _interfaces.UserVeirifedOriginTypes.SOCIAL_LOGIN,
        name
      });
      events == null ? void 0 : (_events$userVerified = events.userVerified) == null ? void 0 : _events$userVerified.call(events, userVerifiedPayload);
      (0, _utils.reportGTMEvent)(_utils.GTMEventAction.USER_VERIFIED, userVerifiedPayload);
    }
    if (userId) {
      localStorage.setItem('userId', userId);
    }
    yield (0, _effects.put)(_reducer.actions.setLoginState({
      email,
      isNewUser
    }));
    yield (0, _saga.refreshTokenForSocialLogins)();
    localStorage.removeItem('register-quick-login');
    yield (0, _effects.put)(_reducer.actions.setSocialLoginsState({
      loading: false
    }));
  } catch (e) {
    yield (0, _effects.put)(_reducer.actions.setSocialLoginsState({
      loading: false,
      error: (0, _utils.errorHandler)(e, 'Failed to authenticate'),
      firstLoad: false
    }));
  }
}
function* setSocialLoginError({
  payload
}) {
  yield (0, _effects.put)(_reducer.actions.setSocialLoginsState({
    error: payload.error,
    loading: false,
    firstLoad: false
  }));
}
function* socialLoginsSaga() {
  yield (0, _effects.takeLeading)(_reducer.actions.loadSocialLoginsConfiguration, loadSocialLoginsConfigurations);
  yield (0, _effects.takeEvery)(_reducer.actions.loadSocialLoginsConfigurationV2, loadSocialLoginsConfigurationsV2);
  yield (0, _effects.takeLeading)(_reducer.actions.loginViaSocialLogin, loginViaSocialLogin);
  yield (0, _effects.takeLatest)(_reducer.actions.setSocialLoginError, setSocialLoginError);
}