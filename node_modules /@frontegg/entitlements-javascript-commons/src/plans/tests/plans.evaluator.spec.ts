import { ConditionLogicEnum, TreatmentEnum } from '../../rules';
import { OperationEnum } from '../../operations/types';
import { Plan } from '../types';
import { evaluatePlan } from '../plan.evaluator';

type PlanCreator = (data?: Partial<Plan>) => Plan;
const planFactory: PlanCreator = (data?: Partial<Plan>) => ({
  defaultTreatment: TreatmentEnum.False,
  ...data,
});

describe('evaluatePlan', () => {
  describe('default treatment', () => {
    it('should return false when no rule is valid and defaultTreatment is false', () => {
      const plan: Plan = planFactory({
        rules: [
          {
            treatment: TreatmentEnum.True,
            conditions: [
              {
                attribute: 'test',
                op: 'not supported' as any,
                value: { list: ['test'] },
                negate: false,
              },
            ],
            conditionLogic: ConditionLogicEnum.And,
          },
        ],
      });

      const result = evaluatePlan(plan, {});

      expect(result).toEqual({ treatment: TreatmentEnum.False });
    });

    it('should return true when no rule is valid and defaultTreatment is true', () => {
      const plan: Plan = planFactory({
        defaultTreatment: TreatmentEnum.True,
        rules: [
          {
            treatment: TreatmentEnum.True,
            conditions: [
              {
                attribute: 'test',
                op: 'not supported' as any,
                value: { list: ['test'] },
                negate: false,
              },
            ],
            conditionLogic: ConditionLogicEnum.And,
          },
        ],
      });

      const result = evaluatePlan(plan, {});

      expect(result).toEqual({ treatment: TreatmentEnum.True });
    });
  });

  describe('complete evaluation', () => {
    it('should return false according to first treatable rule', () => {
      const plan: Plan = planFactory({
        rules: [
          {
            treatment: TreatmentEnum.False,
            conditions: [
              {
                attribute: 'attribute',
                op: OperationEnum.InList,
                value: { list: ['test'] },
                negate: false,
              },
            ],
            conditionLogic: ConditionLogicEnum.And,
          },
        ],
      });

      const result = evaluatePlan(plan, { attribute: 'test' });

      expect(result).toEqual({ treatment: TreatmentEnum.False });
    });

    it('should return true according to first treatable rule', () => {
      const plan: Plan = planFactory({
        rules: [
          {
            treatment: TreatmentEnum.False,
            conditions: [
              {
                attribute: 'test',
                op: 'not supported' as any,
                value: { list: ['test'] },
                negate: false,
              },
            ],
            conditionLogic: ConditionLogicEnum.And,
          },
          {
            treatment: TreatmentEnum.True,
            conditions: [
              {
                attribute: 'attribute',
                op: OperationEnum.InList,
                value: { list: ['test'] },
                negate: false,
              },
            ],
            conditionLogic: ConditionLogicEnum.And,
          },
        ],
      });

      const result = evaluatePlan(plan, { attribute: 'test' });

      expect(result).toEqual({ treatment: TreatmentEnum.True });
    });
  });
});
